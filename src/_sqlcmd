#compdef sqlcmd

# Static zsh completion for sqlcmd (workaround for __complete panic in v1.9.0)
# Original dynamic completion panics: github.com/microsoft/go-sqlcmd/cmd/sqlcmd.isFlag

_sqlcmd() {
    local -a commands
    commands=(
        'config:Modify sqlcmd configuration'
        'create:Create a SQL Server'
        'delete:Delete a SQL Server'
        'help:Help about any command'
        'open:Open a tool for the current context'
        'query:Run a query against the current context'
        'start:Start the current context'
        'stop:Stop the current context'
    )

    local -a global_opts
    global_opts=(
        '(-h --help)'{-h,--help}'[help for sqlcmd]'
        '--version[print version of sqlcmd]'
        '--verbosity[log level: 1=error, 2=warn, 3=info, 4=debug]:level:(1 2 3 4)'
    )

    local -a query_opts
    query_opts=(
        '(-S --server)'{-S,--server}'[server connection string]:server:'
        '(-U --user-name)'{-U,--user-name}'[login ID]:user:'
        '(-P --password)'{-P,--password}'[password]:password:'
        '(-d --database-name)'{-d,--database-name}'[database name]:database:'
        '(-Q --query)'{-Q,--query}'[query to execute]:query:'
        '(-i --input-file)'{-i,--input-file}'[input file]:file:_files'
        '(-o --output-file)'{-o,--output-file}'[output file]:file:_files'
        '(-E --use-trusted-connection)'{-E,--use-trusted-connection}'[use trusted connection]'
        '(-C --trust-server-certificate)'{-C,--trust-server-certificate}'[trust server certificate]'
        '(-N --encrypt-connection)'{-N,--encrypt-connection}'[encrypt connection]:mode:(true false strict)'
        '(-t --query-timeout)'{-t,--query-timeout}'[query timeout in seconds]:seconds:'
        '(-l --login-timeout)'{-l,--login-timeout}'[login timeout in seconds]:seconds:'
        '(-s --col-separator)'{-s,--col-separator}'[column separator]:separator:'
        '(-w --screen-width)'{-w,--screen-width}'[screen width]:width:'
        '(-W --trim-spaces)'{-W,--trim-spaces}'[remove trailing spaces]'
        '(-h --headers)'{-h,--headers}'[rows between headers]:rows:'
        '(-k --remove-control-chars)'{-k,--remove-control-chars}'[remove control characters]:level:(1 2)'
        '--no-cp437[disable CP437 translation]'
        '-b[on error batch abort]'
        '-e[echo input]'
        '-m[error level]:level:'
        '-r[msgs to stderr]:level:(0 1)'
        '-v[scripting variable]:var=value:'
    )

    _arguments -C \
        $global_opts \
        $query_opts \
        '1:command:->command' \
        '*::args:->args'

    case "$state" in
        command)
            _describe -t commands 'sqlcmd commands' commands
            ;;
        args)
            case "${words[1]}" in
                query)
                    _arguments $query_opts
                    ;;
                config)
                    local -a config_cmds
                    config_cmds=(
                        'add-endpoint:Add an endpoint to the config'
                        'add-user:Add a user to the config'
                        'connection-strings:View connection strings'
                        'current-context:Display current context'
                        'delete-context:Delete a context'
                        'delete-endpoint:Delete an endpoint'
                        'delete-user:Delete a user'
                        'get-contexts:List all contexts'
                        'get-endpoints:List all endpoints'
                        'get-users:List all users'
                        'use-context:Switch context'
                        'view:View config file'
                    )
                    _describe -t commands 'config commands' config_cmds
                    ;;
                create)
                    local -a create_cmds
                    create_cmds=(
                        'mssql:Create SQL Server container'
                        'ado:Create Azure DevOps context'
                    )
                    _describe -t commands 'create commands' create_cmds
                    ;;
                open)
                    local -a open_cmds
                    open_cmds=(
                        'ads:Open Azure Data Studio'
                        'vscode:Open VS Code'
                    )
                    _describe -t commands 'open commands' open_cmds
                    ;;
                help)
                    _describe -t commands 'sqlcmd commands' commands
                    ;;
                *)
                    _arguments $global_opts
                    ;;
            esac
            ;;
    esac
}

_sqlcmd "$@"
